  <TestCase name="getExecPlan[q95]">
    <Resource name="sql">
      <![CDATA[/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

-- start query 1 in stream 0 using template query95.tpl and seed 2031708268
with ws_wh as
(select ws1.ws_order_number,ws1.ws_warehouse_sk wh1,ws2.ws_warehouse_sk wh2
 from web_sales ws1,web_sales ws2
 where ws1.ws_order_number = ws2.ws_order_number
   and ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)
 select  
   count(distinct ws_order_number) as `order count`
  ,sum(ws_ext_ship_cost) as `total shipping cost`
  ,sum(ws_net_profit) as `total net profit`
from
   web_sales ws1
  ,date_dim
  ,customer_address
  ,web_site
where
    d_date between '1999-5-01' and 
           (cast('1999-5-01' as date) + interval '60' day)
and ws1.ws_ship_date_sk = d_date_sk
and ws1.ws_ship_addr_sk = ca_address_sk
and ca_state = 'TX'
and ws1.ws_web_site_sk = web_site_sk
and web_company_name = 'pri'
and ws1.ws_order_number in (select ws_order_number
                            from ws_wh)
and ws1.ws_order_number in (select wr_order_number
                            from web_returns,ws_wh
                            where wr_order_number = ws_wh.ws_order_number)
order by count(distinct ws_order_number)
limit 100

-- end query 1 in stream 0 using template query95.tpl
]]>
    </Resource>
    <Resource name="ast">
      <![CDATA[
LogicalSort(sort0=[$0], dir0=[ASC-nulls-first], fetch=[100])
+- LogicalAggregate(group=[{}], order count=[COUNT(DISTINCT $0)], total shipping cost=[SUM($1)], total net profit=[SUM($2)])
   +- LogicalProject(ws_order_number=[$16], ws_ext_ship_cost=[$27], ws_net_profit=[$32])
      +- LogicalFilter(condition=[AND(>=($36, CAST(_UTF-16LE'1999-5-01'):DATE NOT NULL), <=($36, +(CAST(_UTF-16LE'1999-5-01'):DATE NOT NULL, 5184000000:INTERVAL DAY)), =($1, $34), =($10, $62), =($70, _UTF-16LE'TX'), =($12, $75), =($89, _UTF-16LE'pri'), IN($16, {
LogicalProject(ws_order_number=[$16])
  LogicalFilter(condition=[AND(=($16, $50), <>($14, $48))])
    LogicalJoin(condition=[true], joinType=[inner])
      LogicalTableScan(table=[[hive, tpcds_bin_partitioned_orc_10000, web_sales]])
      LogicalTableScan(table=[[hive, tpcds_bin_partitioned_orc_10000, web_sales]])
}), IN($16, {
LogicalProject(wr_order_number=[$12])
  LogicalFilter(condition=[=($12, $24)])
    LogicalJoin(condition=[true], joinType=[inner])
      LogicalTableScan(table=[[hive, tpcds_bin_partitioned_orc_10000, web_returns]])
      LogicalProject(ws_order_number=[$16], wh1=[$14], wh2=[$48])
        LogicalFilter(condition=[AND(=($16, $50), <>($14, $48))])
          LogicalJoin(condition=[true], joinType=[inner])
            LogicalTableScan(table=[[hive, tpcds_bin_partitioned_orc_10000, web_sales]])
            LogicalTableScan(table=[[hive, tpcds_bin_partitioned_orc_10000, web_sales]])
}))])
         +- LogicalJoin(condition=[true], joinType=[inner])
            :- LogicalJoin(condition=[true], joinType=[inner])
            :  :- LogicalJoin(condition=[true], joinType=[inner])
            :  :  :- LogicalTableScan(table=[[hive, tpcds_bin_partitioned_orc_10000, web_sales]])
            :  :  +- LogicalTableScan(table=[[hive, tpcds_bin_partitioned_orc_10000, date_dim]])
            :  +- LogicalTableScan(table=[[hive, tpcds_bin_partitioned_orc_10000, customer_address]])
            +- LogicalTableScan(table=[[hive, tpcds_bin_partitioned_orc_10000, web_site]])
]]>
    </Resource>
    <Resource name="optimized exec plan">
      <![CDATA[
SortLimit(orderBy=[order count ASC], offset=[0], fetch=[100], global=[true])
+- Exchange(distribution=[single])
   +- SortLimit(orderBy=[order count ASC], offset=[0], fetch=[100], global=[false])
      +- HashAggregate(isMerge=[true], select=[Final_COUNT(count$0) AS order count, Final_MIN(min$1) AS total shipping cost, Final_MIN(min$2) AS total net profit])
         +- Exchange(distribution=[single])
            +- LocalHashAggregate(select=[Partial_COUNT(ws_order_number) FILTER $g_0 AS count$0, Partial_MIN(total shipping cost) FILTER $g_1 AS min$1, Partial_MIN(total net profit) FILTER $g_1 AS min$2])
               +- Calc(select=[ws_order_number, total shipping cost, total net profit, (CASE(($e = 0), 0, 1) = 0) AS $g_0, (CASE(($e = 0), 0, 1) = 1) AS $g_1])
                  +- HashAggregate(isMerge=[true], groupBy=[ws_order_number, $e], select=[ws_order_number, $e, Final_SUM(sum$0) AS total shipping cost, Final_SUM(sum$1) AS total net profit])
                     +- Exchange(distribution=[hash[ws_order_number, $e]])
                        +- LocalHashAggregate(groupBy=[ws_order_number, $e], select=[ws_order_number, $e, Partial_SUM(ws_ext_ship_cost) AS sum$0, Partial_SUM(ws_net_profit) AS sum$1])
                           +- Expand(projects=[{ws_order_number, ws_ext_ship_cost, ws_net_profit, 0 AS $e}, {null AS ws_order_number, ws_ext_ship_cost, ws_net_profit, 1 AS $e}])
                              +- HashJoin(joinType=[LeftSemiJoin], where=[(ws_order_number = wr_order_number)], select=[ws_order_number, ws_ext_ship_cost, ws_net_profit], build=[left], tryDistinctBuildRow=[true])
                                 :- HashJoin(joinType=[LeftSemiJoin], where=[(ws_order_number = ws_order_number0)], select=[ws_order_number, ws_ext_ship_cost, ws_net_profit], build=[left], tryDistinctBuildRow=[true])
                                 :  :- Exchange(distribution=[hash[ws_order_number]])
                                 :  :  +- Calc(select=[ws_order_number, ws_ext_ship_cost, ws_net_profit])
                                 :  :     +- HashJoin(joinType=[InnerJoin], where=[(ws_ship_addr_sk = ca_address_sk)], select=[ws_ship_addr_sk, ws_order_number, ws_ext_ship_cost, ws_net_profit, ca_address_sk], isBroadcast=[true], build=[right])
                                 :  :        :- Calc(select=[ws_ship_addr_sk, ws_order_number, ws_ext_ship_cost, ws_net_profit])
                                 :  :        :  +- HashJoin(joinType=[InnerJoin], where=[(ws_web_site_sk = web_site_sk)], select=[ws_ship_addr_sk, ws_web_site_sk, ws_order_number, ws_ext_ship_cost, ws_net_profit, web_site_sk], isBroadcast=[true], build=[right])
                                 :  :        :     :- Calc(select=[ws_ship_addr_sk, ws_web_site_sk, ws_order_number, ws_ext_ship_cost, ws_net_profit])
                                 :  :        :     :  +- HashJoin(joinType=[InnerJoin], where=[(ws_ship_date_sk = d_date_sk)], select=[ws_ship_date_sk, ws_ship_addr_sk, ws_web_site_sk, ws_order_number, ws_ext_ship_cost, ws_net_profit, d_date_sk], isBroadcast=[true], build=[right])
                                 :  :        :     :     :- TableSourceScan(table=[[hive, tpcds_bin_partitioned_orc_10000, web_sales, project=[ws_ship_date_sk, ws_ship_addr_sk, ws_web_site_sk, ws_order_number, ws_ext_ship_cost, ws_net_profit]]], fields=[ws_ship_date_sk, ws_ship_addr_sk, ws_web_site_sk, ws_order_number, ws_ext_ship_cost, ws_net_profit])
                                 :  :        :     :     +- Exchange(distribution=[broadcast])
                                 :  :        :     :        +- Calc(select=[d_date_sk], where=[SEARCH(d_date, Sarg[[1999-05-01..1999-06-30]])])
                                 :  :        :     :           +- TableSourceScan(table=[[hive, tpcds_bin_partitioned_orc_10000, date_dim, project=[d_date_sk, d_date]]], fields=[d_date_sk, d_date])
                                 :  :        :     +- Exchange(distribution=[broadcast])
                                 :  :        :        +- Calc(select=[web_site_sk], where=[SEARCH(web_company_name, Sarg[_UTF-16LE'pri'])])
                                 :  :        :           +- TableSourceScan(table=[[hive, tpcds_bin_partitioned_orc_10000, web_site, project=[web_site_sk, web_company_name]]], fields=[web_site_sk, web_company_name])
                                 :  :        +- Exchange(distribution=[broadcast])
                                 :  :           +- Calc(select=[ca_address_sk], where=[SEARCH(ca_state, Sarg[_UTF-16LE'TX'])])
                                 :  :              +- TableSourceScan(table=[[hive, tpcds_bin_partitioned_orc_10000, customer_address, project=[ca_address_sk, ca_state]]], fields=[ca_address_sk, ca_state])
                                 :  +- LocalHashAggregate(groupBy=[ws_order_number], select=[ws_order_number])
                                 :     +- Calc(select=[ws_order_number])(reuse_id=[2])
                                 :        +- HashJoin(joinType=[InnerJoin], where=[((ws_order_number = ws_order_number0) AND (ws_warehouse_sk <> ws_warehouse_sk0))], select=[ws_warehouse_sk, ws_order_number, ws_warehouse_sk0, ws_order_number0], build=[right])
                                 :           :- Exchange(distribution=[hash[ws_order_number]], shuffle_mode=[BATCH])
                                 :           :  +- TableSourceScan(table=[[hive, tpcds_bin_partitioned_orc_10000, web_sales, project=[ws_warehouse_sk, ws_order_number]]], fields=[ws_warehouse_sk, ws_order_number])(reuse_id=[1])
                                 :           +- Exchange(distribution=[hash[ws_order_number]])
                                 :              +- Reused(reference_id=[1])
                                 +- LocalHashAggregate(groupBy=[wr_order_number], select=[wr_order_number])
                                    +- Calc(select=[wr_order_number])
                                       +- HashJoin(joinType=[InnerJoin], where=[(wr_order_number = ws_order_number)], select=[ws_order_number, wr_order_number], build=[right])
                                          :- Reused(reference_id=[2])
                                          +- Exchange(distribution=[hash[wr_order_number]])
                                             +- TableSourceScan(table=[[hive, tpcds_bin_partitioned_orc_10000, web_returns, project=[wr_order_number]]], fields=[wr_order_number])
]]>
    </Resource>
  </TestCase>
